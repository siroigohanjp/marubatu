<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹</title>
<style>
  body { font-family: sans-serif; background: #0f1724; color: #fff; text-align: center; padding: 20px; }
  #board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; justify-content: center; margin-top: 20px; }
  .cell { width: 100px; height: 100px; background: #1e293b; display: flex; align-items: center; justify-content: center;
    font-size: 48px; cursor: pointer; border-radius: 8px; transition: background 0.3s, box-shadow 0.3s; }
  .cell.disabled { opacity: 0.5; cursor: not-allowed; }
  .win { background: #22c55e !important; box-shadow: 0 0 20px #22c55e; animation: flash 0.8s ease-in-out infinite alternate; }
  .draw { opacity: 0.7; }
  input, button { font-size: 16px; padding: 6px; margin: 4px; }
  #turnInfo { font-size: 22px; margin-top: 15px; font-weight: bold; transition: color 0.4s, text-shadow 0.4s; }
  #turnInfo.active { color: #4ade80; text-shadow: 0 0 10px #4ade80; animation: pulse 1s infinite alternate; }
  .winner { color: #22c55e !important; text-shadow: 0 0 15px #22c55e, 0 0 30px #22c55e; }
  .loser { color: #f87171 !important; text-shadow: 0 0 15px #f87171; }
  .drawText { color: #94a3b8 !important; }
  @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
  @keyframes flash { from { transform: scale(1); } to { transform: scale(1.05); } }
  #chatArea { width: 300px; margin: 20px auto; background: #1e293b; padding: 10px; border-radius: 8px; text-align: left; }
  #chatLog { height: 150px; overflow-y: auto; background: #0f1724; padding: 6px; border-radius: 4px; }
  .chatMsg { margin: 2px 0; }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹ï½–0.0.8</h1>

<div>
  <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›" />
</div>
<div>
  <input id="roomId" placeholder="éƒ¨å±‹ã‚³ãƒ¼ãƒ‰" />
  <button id="createBtn">éƒ¨å±‹ã‚’ä½œã‚‹</button>
  <button id="joinBtn">å‚åŠ ã™ã‚‹</button>
</div>

<div id="status">çŠ¶æ…‹: æœªæ¥ç¶š</div>

<div id="board"></div>
<div id="turnInfo"></div>
<div id="result"></div>
<button id="resetBtn" style="display:none;">ã‚‚ã†ä¸€åº¦éŠã¶</button>

<div id="chatArea">
  <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." disabled />
  <button id="chatSend" disabled>é€ä¿¡</button>
</div>

<script>
// ==== Firebaseè¨­å®š ====
  const firebaseConfig = {
    apiKey: "AIzaSyAI3pNSCaU2teHdqa1Rh1eLoQu1VZYtoh4",
    authDomain: "webrtc-gamesg.firebaseapp.com",
    databaseURL: "https://webrtc-gamesg-default-rtdb.firebaseio.com",
    projectId: "webrtc-gamesg",
    storageBucket: "webrtc-gamesg.firebasestorage.app",
    messagingSenderId: "214608437119",
    appId: "1:214608437119:web:369a938ed095dded62c44a"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== å¤‰æ•° ====
let pc, dc;
let myMark = '-', opMark = '-';
let myTurn = false;
let board = Array(9).fill(null);
let roomRef, chatRef, rematchRef;
let isHost = false, gameOver = false;
let playerName = '';

// ==== ç›¤é¢ç”Ÿæˆ ====
const boardEl = document.getElementById('board');
for (let i = 0; i < 9; i++) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.onclick = () => makeMove(i);
  boardEl.appendChild(cell);
}

// ==== è¡¨ç¤º ====
function render() {
  board.forEach((v, i) => {
    const c = boardEl.children[i];
    c.textContent = v || '';
    c.classList.toggle('disabled', !myTurn || v || gameOver);
  });
  const turnInfo = document.getElementById('turnInfo');
  if (gameOver) {
    turnInfo.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
    turnInfo.classList.remove('active');
  } else {
    turnInfo.textContent = myTurn ? 'ã‚ãªãŸã®æ‰‹ç•ªï¼' : 'ç›¸æ‰‹ã®æ‰‹ç•ªâ€¦';
    turnInfo.classList.toggle('active', myTurn);
  }
}

// ==== å‹æ•—åˆ¤å®š ====
function winCheck() {
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for (const [a,b,c] of lines) {
    if (board[a] && board[a]==board[b] && board[a]==board[c]) return { winner: board[a], line: [a,b,c] };
  }
  if (board.every(Boolean)) return { winner: 'draw' };
  return null;
}

// ==== ä¸€æ‰‹ ====
function makeMove(i) {
  if (!myTurn || board[i] || gameOver) return;
  board[i] = myMark;
  send({type:'move', i});
  myTurn = false;
  render();
  const result = winCheck();
  if (result) {
    gameOver = true;
    send({type:'gameover', winner: result.winner, line: result.line});
    showResult(result.winner, result.line);
  }
}

// ==== çµæœè¡¨ç¤º ====
function showResult(winner, line=[]) {
  const resultEl = document.getElementById('result');
  const turnInfo = document.getElementById('turnInfo');
  const cells = boardEl.children;
  Array.from(cells).forEach(c=>c.classList.remove('win','draw'));
  turnInfo.classList.remove('winner','loser','drawText');

  if (winner === 'draw') {
    resultEl.textContent = 'å¼•ãåˆ†ã‘ï¼';
    turnInfo.textContent = 'å¼•ãåˆ†ã‘ï¼';
    turnInfo.classList.add('drawText');
    Array.from(cells).forEach(c=>c.classList.add('draw'));
  } else {
    const isWin = (winner === myMark);
    resultEl.textContent = isWin ? 'ã‚ãªãŸã®å‹ã¡ï¼ğŸ‰' : 'ã‚ãªãŸã®è² ã‘â€¦ğŸ˜¢';
    turnInfo.textContent = isWin ? 'å‹åˆ©ï¼ğŸ‰' : 'æ•—åŒ—â€¦';
    turnInfo.classList.add(isWin ? 'winner' : 'loser');
    if (line) line.forEach(i => cells[i].classList.add('win'));
  }
  document.getElementById('resetBtn').style.display='inline-block';
  myTurn = false; render();
}

// ==== å†æˆ¦ ====
function setupRematch(roomId) {
  rematchRef = db.ref('rooms/'+roomId+'/rematch');
  rematchRef.remove();
  rematchRef.on('value', snap=>{
    const data = snap.val()||{};
    if(data.hostReady && data.guestReady){
      startRematch();
      rematchRef.remove();
    }
  });
}

document.getElementById('resetBtn').onclick = ()=>{
  document.getElementById('resetBtn').disabled=true;
  document.getElementById('resetBtn').textContent='ç›¸æ‰‹ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...';
  rematchRef.update(isHost?{hostReady:true}:{guestReady:true});
};

function startRematch() {
  board = Array(9).fill(null);
  gameOver = false;
  myTurn = isHost;

  Array.from(boardEl.children).forEach(c => {
    c.textContent = '';
    c.classList.remove('win', 'draw', 'disabled');
  });

  document.getElementById('result').textContent = '';
  const turnInfo = document.getElementById('turnInfo');
  turnInfo.classList.remove('winner', 'loser', 'drawText');
  turnInfo.textContent = myTurn ? 'ã‚ãªãŸã®æ‰‹ç•ªï¼' : 'ç›¸æ‰‹ã®æ‰‹ç•ªâ€¦';
  turnInfo.classList.toggle('active', myTurn);

  document.getElementById('resetBtn').style.display = 'none';
  document.getElementById('resetBtn').disabled = false;
  document.getElementById('resetBtn').textContent = 'ã‚‚ã†ä¸€åº¦éŠã¶';
  render();
}

// ==== Firebaseã‚·ã‚°ãƒŠãƒªãƒ³ã‚° ====
async function createRoom(roomId){
  playerName=document.getElementById('playerName').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
  isHost=true;
  roomRef=db.ref('rooms/'+roomId);
  await roomRef.remove();

  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  dc=pc.createDataChannel('game');
  setupDC();
  pc.onicecandidate=e=>{if(e.candidate)roomRef.child('offerCandidates').push(e.candidate.toJSON());};

  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  await roomRef.set({ offer, host: playerName });

  document.getElementById('status').textContent='éƒ¨å±‹ä½œæˆã€‚å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...';
  setupChat(roomId);
  setupRematch(roomId);

  roomRef.on('value',async snap=>{
    const data=snap.val();
    if(!pc.currentRemoteDescription && data?.answer){
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });
  roomRef.child('answerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

async function joinRoom(roomId){
  playerName=document.getElementById('playerName').value.trim()||'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
  isHost=false;
  roomRef=db.ref('rooms/'+roomId);

  const snap=await roomRef.get();
  if(!snap.exists()){ alert('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  const data = snap.val();

  // 2äººåˆ¶é™ãƒã‚§ãƒƒã‚¯
  if(data.host && data.guest){
    alert('ã“ã®éƒ¨å±‹ã¯ã™ã§ã«2äººãŒå‚åŠ ã—ã¦ã„ã¾ã™');
    return;
  }

  await roomRef.update({ guest: playerName });

  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ondatachannel = e => { dc = e.channel; setupDC(); };
  pc.onicecandidate = e => { if(e.candidate) roomRef.child('answerCandidates').push(e.candidate.toJSON()); };
  await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
  const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
  await roomRef.update({ answer });

  document.getElementById('status').textContent='æ¥ç¶šä¸­...';
  setupChat(roomId);
  setupRematch(roomId);

  roomRef.child('offerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

// ==== DataChannel ====
function setupDC(){
  dc.onopen=()=>{
    document.getElementById('status').textContent='æ¥ç¶šæ¸ˆã¿';
    if(isHost){
      myMark='X'; opMark='O'; myTurn=true;
      send({type:'assign',mark:'O',yourTurn:false});
    }
    render();
    document.getElementById('chatInput').disabled=false;
    document.getElementById('chatSend').disabled=false;
  };

  dc.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==='move'){
      board[data.i]=opMark; myTurn=true; render();
      const result=winCheck(); if(result){gameOver=true;showResult(result.winner,result.line);}
    }else if(data.type==='assign'){
      myMark=data.mark; opMark=(data.mark==='X'?'O':'X');
      myTurn=data.yourTurn||false; render();
    }else if(data.type==='gameover'){
      gameOver=true; showResult(data.winner,data.line);
    }
  };
}
function send(obj){dc.send(JSON.stringify(obj));}

// ==== ãƒãƒ£ãƒƒãƒˆ ====
function setupChat(roomId){
  const chatLog=document.getElementById('chatLog');
  const chatSend=document.getElementById('chatSend');
  const chatInput=document.getElementById('chatInput');
  chatLog.innerHTML='';
  chatRef=db.ref(`rooms/${roomId}/chat`);
  chatRef.off();
  chatSend.onclick=async()=>{
    const msg=chatInput.value.trim();
    if(!msg||!chatRef)return;
    await chatRef.push({name:playerName,msg,time:Date.now()});
    chatInput.value='';
  };
  chatRef.on('child_added',snap=>{
    const {name,msg}=snap.val();
    const div=document.createElement('div');
    div.className='chatMsg';
    div.textContent=`${name}: ${msg}`;
    chatLog.appendChild(div);
    chatLog.scrollTop=chatLog.scrollHeight;
  });
}

// ==== UI ====
document.getElementById('createBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  createRoom(id);
};
document.getElementById('joinBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  joinRoom(id);
};
</script>
</body>
</html>
