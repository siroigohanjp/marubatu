<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>オンライン三目並べ</title>
<style>
body {
  font-family: sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
  margin: 0;
  padding: 20px;
}
#board {
  display: grid;
  grid-template-columns: repeat(3, 100px);
  gap: 5px;
  justify-content: center;
  margin: 20px auto;
}
.cell {
  width: 100px;
  height: 100px;
  background: #222;
  font-size: 60px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 10px;
  transition: background 0.3s;
}
.cell:hover { background: #333; }
#chat { margin-top: 20px; }
#chatLog {
  width: 320px;
  height: 150px;
  overflow-y: auto;
  margin: 0 auto;
  padding: 5px;
  background: #222;
  text-align: left;
}
#status {
  margin-top: 10px;
  font-weight: bold;
  color: #0f0;
}
.turn-highlight {
  color: #ff0;
  font-weight: bold;
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<h1>オンライン三目並べｖ0.0.18</h1>
<div>
  名前: <input id="playerName" placeholder="プレイヤー名">
</div>
<div>
  <button id="createBtn">部屋を作成</button>
  <input id="roomId" placeholder="部屋コード">
  <button id="joinBtn">参加</button>
</div>

<div id="status">状態: 未接続</div>
<div id="turnInfo"></div>

<div id="board"></div>

<div id="chat">
  <h3>チャット</h3>
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="メッセージ">
  <button id="chatSend">送信</button>
</div>

<button id="leaveBtn" style="display:none;">退出</button>

<script>
// === Firebase初期化 ===
const firebaseConfig = {
  apiKey: "AIzaSyD7x-Wc1jztklSmv3m2SaNADnq2O-A8RQ4",
  authDomain: "tictactoe-online.firebaseapp.com",
  databaseURL: "https://tictactoe-online-default-rtdb.firebaseio.com/",
  projectId: "tictactoe-online",
  storageBucket: "tictactoe-online.appspot.com",
  messagingSenderId: "774682100003",
  appId: "1:774682100003:web:a8ccbc0d586bfdf2f2b5cf"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// === 変数 ===
let roomRef, chatRef, dc;
let isHost = false;
let myMark = '';
let myTurn = false;
let board = Array(9).fill(null);
let gameOver = false;
let currentRoomId = null;

// === UI要素 ===
const boardEl = document.getElementById('board');
for (let i=0;i<9;i++){
  const cell = document.createElement('div');
  cell.className='cell';
  cell.dataset.index=i;
  cell.onclick=()=>clickCell(i);
  boardEl.appendChild(cell);
}

// === 関数 ===
function render(){
  board.forEach((v,i)=>{ boardEl.children[i].textContent=v?v:''; });
  document.getElementById('turnInfo').innerHTML = myTurn ? 
    `<span class="turn-highlight">あなたの番です</span>` : 
    '相手の番です';
}
function send(obj){ if(dc && dc.readyState==='open') dc.send(JSON.stringify(obj)); }
function resetGameUI(full=true){
  board = Array(9).fill(null);
  myMark='';
  myTurn=false;
  gameOver=false;
  boardEl.querySelectorAll('.cell').forEach(c=>c.textContent='');
  document.getElementById('chatLog').innerHTML='';
  document.getElementById('turnInfo').textContent='';
  document.getElementById('status').textContent='状態: 未接続';
  if(full) document.getElementById('playerName').value='';
}

// === ルーム作成 ===
document.getElementById('createBtn').onclick = async()=>{
  const name = document.getElementById('playerName').value.trim();
  if(!name) return alert('名前を入力してください');
  isHost = true;
  const newRoom = db.ref('rooms').push();
  roomRef = newRoom;
  currentRoomId = newRoom.key;
  await roomRef.set({ host:name, guest:null, state:'waiting' });
  chatRef = db.ref(`chats/${currentRoomId}`);
  document.getElementById('status').textContent='部屋コード: '+currentRoomId+'（待機中）';
  document.getElementById('leaveBtn').style.display='inline';
  waitForGuest();
};

// === ルーム参加 ===
document.getElementById('joinBtn').onclick = async()=>{
  const name = document.getElementById('playerName').value.trim();
  const id = document.getElementById('roomId').value.trim();
  if(!name||!id) return alert('名前と部屋コードを入力してください');
  const r = db.ref(`rooms/${id}`);
  const snap = await r.get();
  if(!snap.exists()) return alert('部屋が存在しません');
  const data = snap.val();
  if(data.guest) return alert('満員です');
  await r.update({ guest:name, state:'ready' });
  isHost=false; roomRef=r; currentRoomId=id;
  chatRef = db.ref(`chats/${currentRoomId}`);
  startGame('O');
};

// === ゲスト待ち ===
function waitForGuest(){
  roomRef.on('value', snap=>{
    const data=snap.val(); if(!data) return;
    if(data.guest && data.state==='ready'){
      startGame('X');
    }
  });
}

// === ゲーム開始 ===
function startGame(mark){
  myMark=mark;
  myTurn = (mark==='X');
  document.getElementById('status').textContent = '状態: 対戦中';
  render();
  chatRef.on('child_added', snap=>{
    const msg=snap.val();
    const log=document.getElementById('chatLog');
    log.innerHTML += `<div><b>${msg.name}:</b> ${msg.text}</div>`;
    log.scrollTop=log.scrollHeight;
  });
  document.getElementById('chatSend').onclick=()=>{
    const txt=document.getElementById('chatInput').value.trim();
    if(!txt) return;
    chatRef.push({name:document.getElementById('playerName').value,text:txt});
    document.getElementById('chatInput').value='';
  };
  document.getElementById('chatInput').disabled=false;
  document.getElementById('chatSend').disabled=false;
  document.getElementById('leaveBtn').style.display='inline';
  setupRTC();
}

// === RTC ===
async function setupRTC(){
  const pc = new RTCPeerConnection();
  dc = pc.createDataChannel('game');
  dc.onmessage = e => {
    const data=JSON.parse(e.data);
    if(data.type==='move'){
      board[data.i]=data.mark;
      checkWin();
      myTurn=true;
      render();
    } else if(data.type==='guestLeft'){
      // ゲスト退出時ホストをリセット
      board=Array(9).fill(null);
      boardEl.querySelectorAll('.cell').forEach(c=>c.textContent='');
      document.getElementById('chatLog').innerHTML='';
      document.getElementById('turnInfo').textContent='相手が退出しました。待機中...';
      document.getElementById('status').textContent='状態: 待機中';
    }
  };
}

// === マスクリック ===
function clickCell(i){
  if(!myTurn||gameOver||board[i]) return;
  board[i]=myMark;
  send({type:'move',i,mark:myMark});
  myTurn=false;
  render();
  checkWin();
}

// === 勝敗判定 ===
function checkWin(){
  const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b,c] of lines){
    if(board[a] && board[a]===board[b] && board[a]===board[c]){
      gameOver=true;
      document.getElementById('turnInfo').innerHTML=`<span class="turn-highlight">${board[a]}の勝ち！</span>`;
      return;
    }
  }
  if(board.every(v=>v)) { gameOver=true; document.getElementById('turnInfo').textContent='引き分け'; }
}

// === 退出 ===
document.getElementById('leaveBtn').onclick = ()=> leaveRoom(currentRoomId);

async function leaveRoom(roomId){
  if(!roomRef) return;
  const isGuest = !isHost;

  if(isHost){
    if(chatRef) await chatRef.remove();
    await roomRef.remove();
    resetGameUI(false);
    document.getElementById('status').textContent='状態: 未接続（部屋を閉じました）';
    currentRoomId=null;
  }else{
    await roomRef.update({guest:null});
    if(chatRef) await chatRef.remove();
    try{ send({type:'guestLeft'}); }catch{}
    resetGameUI(false);
    document.getElementById('status').textContent='状態: 未接続（退出しました）';
    currentRoomId=null;
  }
}
</script>
</body>
</html>
