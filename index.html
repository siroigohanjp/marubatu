<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹ v0.0.17</title>
<style>
body { font-family: sans-serif; background:#0f1724; color:#fff; text-align:center; padding:20px; }
#board { display:grid; grid-template-columns:repeat(3,100px); gap:5px; justify-content:center; margin-top:20px; }
.cell { width:100px; height:100px; background:#1e293b; display:flex; align-items:center; justify-content:center; font-size:48px; cursor:pointer; border-radius:8px; transition:background 0.3s, box-shadow 0.3s; }
.cell.disabled { opacity:0.5; cursor:not-allowed; }
.win { background:#22c55e!important; box-shadow:0 0 20px #22c55e; animation:flash 0.8s ease-in-out infinite alternate; }
.draw { opacity:0.7; }
input,button { font-size:16px; padding:6px; margin:4px; }
#turnInfo { font-size:22px; margin-top:15px; font-weight:bold; transition:color 0.4s, text-shadow 0.4s; }
#turnInfo.active { color:#4ade80; text-shadow:0 0 10px #4ade80; animation:pulse 1s infinite alternate; }
.winner { color:#22c55e!important; text-shadow:0 0 15px #22c55e,0 0 30px #22c55e; }
.loser { color:#f87171!important; text-shadow:0 0 15px #f87171; }
.drawText { color:#94a3b8!important; }
@keyframes pulse { from{transform:scale(1);} to{transform:scale(1.1);} }
@keyframes flash { from{transform:scale(1);} to{transform:scale(1.05);} }
#chatArea { width:300px; margin:20px auto; background:#1e293b; padding:10px; border-radius:8px; text-align:left; }
#chatLog { height:150px; overflow-y:auto; background:#0f1724; padding:6px; border-radius:4px; }
.chatMsg { margin:2px 0; }
#roomList { margin:10px auto; width:300px; text-align:left; background:#1e293b; padding:10px; border-radius:8px; }
.roomItem { padding:4px; margin:2px 0; background:#0f1724; border-radius:4px; cursor:pointer; display:flex; justify-content:space-between; }
</style>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹ v0.0.17</h1>
<div><input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›" /></div>
<div>
  <input id="roomId" placeholder="éƒ¨å±‹ã‚³ãƒ¼ãƒ‰" />
  <button id="createBtn">éƒ¨å±‹ã‚’ä½œã‚‹</button>
  <button id="joinBtn">å‚åŠ ã™ã‚‹</button>
  <button id="leaveBtn" style="display:none;">é€€å‡º</button>
</div>
<div id="status">çŠ¶æ…‹: æœªæ¥ç¶š</div>
<div id="roomList"></div>
<div id="board"></div>
<div id="turnInfo"></div>
<div id="result"></div>
<button id="resetBtn" style="display:none;">ã‚‚ã†ä¸€åº¦éŠã¶</button>

<div id="chatArea">
  <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." disabled />
  <button id="chatSend" disabled>é€ä¿¡</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAI3pNSCaU2teHdqa1Rh1eLoQu1VZYtoh4",
  authDomain: "webrtc-gamesg.firebaseapp.com",
  databaseURL: "https://webrtc-gamesg-default-rtdb.firebaseio.com",
  projectId: "webrtc-gamesg",
  storageBucket: "webrtc-gamesg.firebasestorage.app",
  messagingSenderId: "214608437119",
  appId: "1:214608437119:web:369a938ed095dded62c44a"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

let pc,dc;
let myMark='-',opMark='-';
let myTurn=false;
let board=Array(9).fill(null);
let roomRef,chatRef,rematchRef;
let isHost=false,gameOver=false;
let playerName='';
let currentRoomId=null;

const boardEl=document.getElementById('board');
for(let i=0;i<9;i++){
  const c=document.createElement('div');
  c.className='cell';
  c.onclick=()=>makeMove(i);
  boardEl.appendChild(c);
}

function render(){
  board.forEach((v,i)=>{
    const c=boardEl.children[i];
    c.textContent=v||'';
    c.classList.toggle('disabled',!myTurn||v||gameOver);
  });
  const info=document.getElementById('turnInfo');
  if(gameOver){
    info.textContent='ã‚²ãƒ¼ãƒ çµ‚äº†';
    info.classList.remove('active');
  }else{
    info.textContent=myTurn?'ã‚ãªãŸã®æ‰‹ç•ªï¼':'ç›¸æ‰‹ã®æ‰‹ç•ªâ€¦';
    info.classList.toggle('active',myTurn);
  }
}

function winCheck(){
  const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b,c] of lines)
    if(board[a]&&board[a]==board[b]&&board[a]==board[c])
      return {winner:board[a],line:[a,b,c]};
  if(board.every(Boolean)) return {winner:'draw'};
  return null;
}

function makeMove(i){
  if(!myTurn||board[i]||gameOver) return;
  board[i]=myMark;
  send({type:'move',i});
  myTurn=false;
  render();
  const r=winCheck();
  if(r){
    gameOver=true;
    send({type:'gameover',winner:r.winner,line:r.line});
    showResult(r.winner,r.line);
  }
}

function showResult(winner,line=[]){
  const result=document.getElementById('result');
  const info=document.getElementById('turnInfo');
  Array.from(boardEl.children).forEach(c=>c.classList.remove('win','draw'));
  info.classList.remove('winner','loser','drawText');
  if(winner==='draw'){
    result.textContent='å¼•ãåˆ†ã‘ï¼';
    info.textContent='å¼•ãåˆ†ã‘ï¼';
    info.classList.add('drawText');
    Array.from(boardEl.children).forEach(c=>c.classList.add('draw'));
  }else{
    const isWin=(winner===myMark);
    result.textContent=isWin?'ã‚ãªãŸã®å‹ã¡ï¼ğŸ‰':'ã‚ãªãŸã®è² ã‘â€¦ğŸ˜¢';
    info.textContent=isWin?'å‹åˆ©ï¼ğŸ‰':'æ•—åŒ—â€¦';
    info.classList.add(isWin?'winner':'loser');
    if(line) line.forEach(i=>boardEl.children[i].classList.add('win'));
  }
  document.getElementById('resetBtn').style.display='inline-block';
  myTurn=false;
  render();
}

function setupRematch(roomId){
  rematchRef=db.ref('rooms/'+roomId+'/rematch');
  rematchRef.remove();
  rematchRef.on('value',snap=>{
    const d=snap.val()||{};
    if(d.hostReady&&d.guestReady){startRematch();rematchRef.remove();}
  });
}

document.getElementById('resetBtn').onclick=()=>{
  document.getElementById('resetBtn').disabled=true;
  document.getElementById('resetBtn').textContent='ç›¸æ‰‹ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...';
  rematchRef.update(isHost?{hostReady:true}:{guestReady:true});
};

function startRematch(){
  board=Array(9).fill(null);
  gameOver=false;
  myTurn=isHost;
  Array.from(boardEl.children).forEach(c=>{c.textContent='';c.classList.remove('win','draw','disabled');});
  document.getElementById('result').textContent='';
  const info=document.getElementById('turnInfo');
  info.classList.remove('winner','loser','drawText');
  info.textContent=myTurn?'ã‚ãªãŸã®æ‰‹ç•ªï¼':'ç›¸æ‰‹ã®æ‰‹ç•ªâ€¦';
  info.classList.toggle('active',myTurn);
  document.getElementById('resetBtn').style.display='none';
  document.getElementById('resetBtn').disabled=false;
  document.getElementById('resetBtn').textContent='ã‚‚ã†ä¸€åº¦éŠã¶';
  render();
}

document.getElementById('leaveBtn').onclick=()=>{
  if(currentRoomId) leaveRoom(currentRoomId);
};

async function leaveRoom(roomId){
  if(!roomRef) return;
  const snap=await roomRef.get();
  const data=snap.val();
  if(isHost){
    if(data?.guest){
      await roomRef.update({host:null});
      if(chatRef) await chatRef.remove();
    }else{
      if(chatRef) await chatRef.remove();
      await roomRef.remove();
    }
  }else{
    await roomRef.update({guest:null});
    if(chatRef) await chatRef.remove();
  }
  // åå‰ä»¥å¤–ãƒªã‚»ãƒƒãƒˆ
  const name=document.getElementById('playerName').value;
  resetGameUI();
  document.getElementById('playerName').value=name;
  currentRoomId=null;
}

function resetGameUI(){
  board=Array(9).fill(null);
  myMark=opMark='-';
  myTurn=false; gameOver=false;
  roomRef=chatRef=rematchRef=null;
  document.getElementById('status').textContent='çŠ¶æ…‹: æœªæ¥ç¶š';
  document.getElementById('turnInfo').textContent='';
  document.getElementById('result').textContent='';
  document.getElementById('chatLog').innerHTML='';
  Array.from(boardEl.children).forEach(c=>{c.textContent='';c.classList.remove('win','draw','disabled');});
  document.getElementById('resetBtn').style.display='none';
  document.getElementById('leaveBtn').style.display='none';
  document.getElementById('chatInput').disabled=true;
  document.getElementById('chatSend').disabled=true;
}

function setupDC(){
  dc.onopen=()=>{
    document.getElementById('status').textContent='æ¥ç¶šæ¸ˆã¿';
    if(isHost){
      myMark='X'; opMark='O'; myTurn=true;
      send({type:'assign',mark:'O',yourTurn:false});
    }
    render();
    document.getElementById('chatInput').disabled=false;
    document.getElementById('chatSend').disabled=false;
  };
  dc.onmessage=e=>{
    const d=JSON.parse(e.data);
    if(d.type==='move'){
      board[d.i]=opMark; myTurn=true; render();
      const r=winCheck(); if(r){ gameOver=true; showResult(r.winner,r.line); }
    }else if(d.type==='assign'){
      myMark=d.mark; opMark=(d.mark==='X'?'O':'X'); myTurn=d.yourTurn; render();
    }else if(d.type==='gameover'){
      gameOver=true; showResult(d.winner,d.line);
    }
  };
}
function send(o){ dc.send(JSON.stringify(o)); }

function setupChat(roomId){
  const log=document.getElementById('chatLog');
  const sendBtn=document.getElementById('chatSend');
  const input=document.getElementById('chatInput');
  log.innerHTML='';
  chatRef=db.ref('rooms/'+roomId+'/chat');
  chatRef.off();
  sendBtn.onclick=async()=>{
    const msg=input.value.trim();
    if(!msg||!chatRef) return;
    await chatRef.push({name:playerName,msg,time:Date.now()});
    input.value='';
  };
  chatRef.on('child_added',s=>{
    const {name,msg}=s.val();
    const div=document.createElement('div');
    div.className='chatMsg';
    div.textContent=`${name}: ${msg}`;
    log.appendChild(div);
    log.scrollTop=log.scrollHeight;
  });
}

async function createRoom(id){
  playerName=document.getElementById('playerName').value.trim();
  if(!playerName){ alert('åå‰ã‚’å…¥åŠ›'); return; }
  roomRef=db.ref('rooms/'+id);
  const s=await roomRef.get();
  if(s.exists()){ alert('ãã®éƒ¨å±‹IDã¯ä½¿ç”¨ä¸­'); return; }
  isHost=true; currentRoomId=id;
  await roomRef.set({host:playerName});
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  dc=pc.createDataChannel('game'); setupDC();
  pc.onicecandidate=e=>{ if(e.candidate) roomRef.child('offerCandidates').push(e.candidate.toJSON()); };
  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  await roomRef.update({offer});
  document.getElementById('status').textContent='éƒ¨å±‹ä½œæˆã€‚å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...';
  setupChat(id); setupRematch(id);
  document.getElementById('leaveBtn').style.display='inline-block';
  roomRef.on('value',async s=>{
    const d=s.val(); if(!pc.currentRemoteDescription && d?.answer){ await pc.setRemoteDescription(new RTCSessionDescription(d.answer)); }
  });
  roomRef.child('answerCandidates').on('child_added',async s=>{ try{ await pc.addIceCandidate(new RTCIceCandidate(s.val())); }catch{} });
}

async function joinRoom(id){
  playerName=document.getElementById('playerName').value.trim();
  if(!playerName){ alert('åå‰ã‚’å…¥åŠ›'); return; }
  currentRoomId=id; roomRef=db.ref('rooms/'+id);
  const s=await roomRef.get(); if(!s.exists()){ alert('éƒ¨å±‹ãŒå­˜åœ¨ã—ã¾ã›ã‚“'); return; }
  const d=s.val(); if(d.host && d.guest){ alert('æº€å“¡ã§ã™'); return; }
  await roomRef.update({guest:playerName});
  isHost=false;
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ondatachannel=e=>{ dc=e.channel; setupDC(); };
  pc.onicecandidate=e=>{ if(e.candidate) roomRef.child('answerCandidates').push(e.candidate.toJSON()); };
  await pc.setRemoteDescription(new RTCSessionDescription(d.offer));
  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await roomRef.update({answer});
  myMark='O'; opMark='X'; myTurn=false; render();
  document.getElementById('status').textContent='æ¥ç¶šä¸­...';
  setupChat(id); setupRematch(id);
  document.getElementById('leaveBtn').style.display='inline-block';
  roomRef.child('offerCandidates').on('child_added',async s=>{ try{ await pc.addIceCandidate(new RTCIceCandidate(s.val())); }catch{} });
}

document.getElementById('createBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  const name=document.getElementById('playerName').value.trim();
  if(!name){ alert('åå‰ã‚’å…¥åŠ›'); return; }
  if(!id){ alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return; }
  createRoom(id);
};

document.getElementById('joinBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  const name=document.getElementById('playerName').value.trim();
  if(!name){ alert('åå‰ã‚’å…¥åŠ›'); return; }
  if(!id){ alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return; }
  joinRoom(id);
};
</script>
</body>
</html>
