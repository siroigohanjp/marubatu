<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹</title>
<style>
  body { font-family: sans-serif; background: #0f1724; color: #fff; text-align: center; padding: 20px; }
  #board { display: grid; grid-template-columns: repeat(3, 100px); gap: 5px; justify-content: center; margin-top: 20px; }
  .cell { width: 100px; height: 100px; background: #1e293b; display: flex; align-items: center; justify-content: center; font-size: 48px; cursor: pointer; border-radius: 8px; transition: background 0.3s; }
  .cell.disabled { opacity: 0.5; cursor: not-allowed; }
  input, button { font-size: 16px; padding: 6px; margin: 4px; }
  #turnInfo { font-size: 22px; margin-top: 15px; font-weight: bold; }
  #turnInfo.active { color: #4ade80; text-shadow: 0 0 10px #4ade80; animation: pulse 1s infinite alternate; }
  @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
  #chatArea { width: 300px; margin: 20px auto; background: #1e293b; padding: 10px; border-radius: 8px; text-align: left; }
  #chatLog { height: 150px; overflow-y: auto; background: #0f1724; padding: 6px; border-radius: 4px; }
  .chatMsg { margin: 2px 0; }
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹ï½–0.0.1</h1>

<div>
  <input id="playerName" placeholder="åå‰ã‚’å…¥åŠ›" />
</div>
<div>
  <input id="roomId" placeholder="éƒ¨å±‹ã‚³ãƒ¼ãƒ‰" />
  <button id="createBtn">éƒ¨å±‹ã‚’ä½œã‚‹</button>
  <button id="joinBtn">å‚åŠ ã™ã‚‹</button>
</div>

<div id="status">çŠ¶æ…‹: æœªæ¥ç¶š</div>

<div id="board"></div>
<div id="turnInfo"></div>
<div id="result"></div>
<button id="resetBtn" style="display:none;">ã‚‚ã†ä¸€åº¦éŠã¶</button>

<div id="chatArea">
  <h3>ãƒãƒ£ãƒƒãƒˆ</h3>
  <div id="chatLog"></div>
  <input id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸..." />
  <button id="chatSend">é€ä¿¡</button>
</div>

<script>
// ==== Firebaseè¨­å®šï¼ˆâ˜…è‡ªåˆ†ã®ã«ç½®ãæ›ãˆï¼‰ ====
  const firebaseConfig = {
    apiKey: "AIzaSyAI3pNSCaU2teHdqa1Rh1eLoQu1VZYtoh4",
    authDomain: "webrtc-gamesg.firebaseapp.com",
    databaseURL: "https://webrtc-gamesg-default-rtdb.firebaseio.com",
    projectId: "webrtc-gamesg",
    storageBucket: "webrtc-gamesg.firebasestorage.app",
    messagingSenderId: "214608437119",
    appId: "1:214608437119:web:369a938ed095dded62c44a"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== å¤‰æ•°å®šç¾© ====
let pc, dc;
let myMark = '-', opMark = '-';
let myTurn = false;
let board = Array(9).fill(null);
let roomRef;
let chatRef;
let isHost = false;
let gameOver = false;
let playerName = '';

// ==== ç›¤é¢ç”Ÿæˆ ====
const boardEl = document.getElementById('board');
for (let i = 0; i < 9; i++) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.dataset.i = i;
  cell.onclick = () => makeMove(i);
  boardEl.appendChild(cell);
}

// ==== è¡¨ç¤ºæ›´æ–° ====
function render() {
  board.forEach((v, i) => {
    const c = boardEl.children[i];
    c.textContent = v || '';
    c.classList.toggle('disabled', !myTurn || v || gameOver);
  });
  const turnInfo = document.getElementById('turnInfo');
  if (gameOver) turnInfo.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
  else {
    turnInfo.textContent = myTurn ? 'ã‚ãªãŸã®æ‰‹ç•ªï¼' : 'ç›¸æ‰‹ã®æ‰‹ç•ªâ€¦';
    turnInfo.classList.toggle('active', myTurn);
  }
}

function winCheck() {
  const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for (const [a,b,c] of lines) {
    if (board[a] && board[a]==board[b] && board[a]==board[c]) return board[a];
  }
  if (board.every(Boolean)) return 'draw';
  return null;
}

function makeMove(i) {
  if (!myTurn || board[i] || gameOver) return;
  board[i] = myMark;
  send({type: 'move', i});
  myTurn = false;
  render();
  const w = winCheck();
  if (w) {
    gameOver = true;
    send({type: 'gameover', winner: w});
    showResult(w);
  }
}

function showResult(winner) {
  const resultEl = document.getElementById('result');
  if (winner === 'draw') resultEl.textContent = 'å¼•ãåˆ†ã‘ï¼';
  else if (winner === myMark) resultEl.textContent = 'ã‚ãªãŸã®å‹ã¡ï¼ğŸ‰';
  else resultEl.textContent = 'ã‚ãªãŸã®è² ã‘â€¦ğŸ˜¢';
  document.getElementById('resetBtn').style.display = 'inline-block';
  myTurn = false;
  render();
}

// ==== Firebaseã‚·ã‚°ãƒŠãƒªãƒ³ã‚° ====
async function createRoom(roomId) {
  playerName = document.getElementById('playerName').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
  isHost = true;
  roomRef = db.ref('rooms/' + roomId);
  await roomRef.remove();
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  dc = pc.createDataChannel('game');
  setupDC();
  pc.onicecandidate = e => { if (e.candidate) roomRef.child('offerCandidates').push(e.candidate.toJSON()); };
  const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
  await roomRef.set({ offer: offer });
  document.getElementById('status').textContent = 'éƒ¨å±‹ã‚’ä½œæˆã—ã¾ã—ãŸã€‚å‚åŠ è€…ã‚’å¾…ã£ã¦ã„ã¾ã™...';
  chatRef = db.ref('rooms/' + roomId + '/chat');
  setupChat();

  roomRef.on('value', async snap => {
    const data = snap.val();
    if (!pc.currentRemoteDescription && data?.answer) {
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
    }
  });
  roomRef.child('answerCandidates').on('child_added', async s => {
    try { await pc.addIceCandidate(new RTCIceCandidate(s.val())); } catch {}
  });
}

async function joinRoom(roomId) {
  playerName = document.getElementById('playerName').value.trim() || 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
  isHost = false;
  roomRef = db.ref('rooms/' + roomId);
  const snap = await roomRef.get();
  if (!snap.exists()) { alert('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }
  const offer = snap.val().offer;
  pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
  pc.ondatachannel = e => { dc = e.channel; setupDC(); };
  pc.onicecandidate = e => { if (e.candidate) roomRef.child('answerCandidates').push(e.candidate.toJSON()); };
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
  await roomRef.update({ answer: answer });
  document.getElementById('status').textContent = 'æ¥ç¶šä¸­...';
  chatRef = db.ref('rooms/' + roomId + '/chat');
  setupChat();

  roomRef.child('offerCandidates').on('child_added', async s => {
    try { await pc.addIceCandidate(new RTCIceCandidate(s.val())); } catch {}
  });
}

// ==== DataChannel ====
function setupDC() {
  dc.onopen = () => {
    document.getElementById('status').textContent = 'æ¥ç¶šæ¸ˆã¿';
    if (isHost) {
      myMark = 'X'; opMark = 'O'; myTurn = true;
      send({ type: 'assign', mark: 'O', yourTurn: false });
    }
    render();
  };

  dc.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'move') {
      board[data.i] = opMark;
      myTurn = true;
      render();
      const w = winCheck();
      if (w) {
        gameOver = true;
        showResult(w);
      }
    } else if (data.type === 'assign') {
      myMark = data.mark;
      opMark = (data.mark === 'X' ? 'O' : 'X');
      myTurn = data.yourTurn || false;
      render();
    } else if (data.type === 'gameover') {
      gameOver = true;
      showResult(data.winner);
    }
  };
}

function send(obj) { dc.send(JSON.stringify(obj)); }

// ==== ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ====
let chatListenerSet = false;
function setupChat() {
  const chatSend = document.getElementById('chatSend');
  const chatInput = document.getElementById('chatInput');
  const chatLog = document.getElementById('chatLog');

  chatSend.disabled = false;
  chatSend.onclick = async () => {
    const msg = chatInput.value.trim();
    if (!msg || !chatRef) return;
    await chatRef.push({ name: playerName, msg, time: Date.now() });
    chatInput.value = '';
  };

  if (chatListenerSet) return;
  chatListenerSet = true;
  chatRef.on('child_added', snap => {
    const { name, msg } = snap.val();
    const div = document.createElement('div');
    div.className = 'chatMsg';
    div.textContent = `${name}: ${msg}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  });
}

// ==== UIãƒœã‚¿ãƒ³ ====
document.getElementById('createBtn').onclick = () => {
  const id = document.getElementById('roomId').value.trim();
  if (!id) { alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  createRoom(id);
};
document.getElementById('joinBtn').onclick = () => {
  const id = document.getElementById('roomId').value.trim();
  if (!id) { alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  joinRoom(id);
};
document.getElementById('resetBtn').onclick = () => { location.reload(); };
</script>
</body>
</html>
