<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹v0.0.1</title>
<style>
  body{font-family:sans-serif;background:#0f1724;color:#fff;text-align:center;padding:20px;}
  #board{display:grid;grid-template-columns:repeat(3,100px);gap:5px;justify-content:center;margin-top:20px;}
  .cell{width:100px;height:100px;background:#1e293b;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;border-radius:8px;}
  .cell.disabled{opacity:0.5;cursor:not-allowed;}
  input,button{font-size:16px;padding:8px;margin:4px;border-radius:6px;border:none;}
  #chatArea{margin-top:20px;width:300px;margin-inline:auto;text-align:left;}
  #chatLog{height:150px;overflow-y:auto;background:#1e293b;padding:10px;border-radius:6px;}
  .msg.self{text-align:right;color:#38bdf8;}
  .msg.other{text-align:left;color:#facc15;}
  #controls{margin-top:10px;}
</style>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ä¸‰ç›®ä¸¦ã¹</h1>

<div>
  <input id="roomId" placeholder="éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›" />
  <button id="createBtn">éƒ¨å±‹ã‚’ä½œã‚‹</button>
  <button id="joinBtn">å‚åŠ ã™ã‚‹</button>
  <button id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<div id="status">çŠ¶æ…‹: æœªæ¥ç¶š</div>
<div id="turnInfo"></div>
<div id="board"></div>
<div id="result"></div>

<!-- ãƒãƒ£ãƒƒãƒˆ -->
<div id="chatArea">
  <h3>ğŸ’¬ ãƒãƒ£ãƒƒãƒˆ</h3>
  <div id="chatLog"></div>
  <div id="controls">
    <input id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›" style="width:200px;">
    <button id="sendBtn">é€ä¿¡</button>
  </div>
</div>

<script>
// ==== Firebaseè¨­å®šï¼ˆâ˜…ã‚ãªãŸã®Firebaseè¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰ ====
  const firebaseConfig = {
    apiKey: "AIzaSyAI3pNSCaU2teHdqa1Rh1eLoQu1VZYtoh4",
    authDomain: "webrtc-gamesg.firebaseapp.com",
    databaseURL: "https://webrtc-gamesg-default-rtdb.firebaseio.com",
    projectId: "webrtc-gamesg",
    storageBucket: "webrtc-gamesg.firebasestorage.app",
    messagingSenderId: "214608437119",
    appId: "1:214608437119:web:369a938ed095dded62c44a"
  };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== WebRTC + ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ====
let pc, dc;
let myMark = '-', opMark = '-';
let myTurn = false;
let board = Array(9).fill(null);
let roomRef;
let isHost = false;

// ç›¤é¢ç”Ÿæˆ
const boardEl = document.getElementById('board');
for(let i=0;i<9;i++){
  const cell=document.createElement('div');
  cell.className='cell';
  cell.dataset.i=i;
  cell.onclick=()=>makeMove(i);
  boardEl.appendChild(cell);
}

function render(){
  board.forEach((v,i)=>{
    const c=boardEl.children[i];
    c.textContent=v||'';
    c.classList.toggle('disabled',!myTurn||v);
  });
  document.getElementById('turnInfo').textContent=myTurn?'ã‚ãªãŸã®æ‰‹ç•ª ('+myMark+')':'ç›¸æ‰‹ã®æ‰‹ç•ª ('+opMark+')';
}
function winCheck(){
  const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b,c] of lines){
    if(board[a]&&board[a]==board[b]&&board[a]==board[c]) return board[a];
  }
  if(board.every(Boolean)) return 'draw';
  return null;
}
function makeMove(i){
  if(!myTurn||board[i])return;
  board[i]=myMark;
  send({type:'move',i});
  myTurn=false;render();
  const w=winCheck();
  if(w){
    send({type:'gameover',winner:w});
    showResult(w);
  }
}
function showResult(w){
  document.getElementById('result').textContent=(w==='draw')?'å¼•ãåˆ†ã‘':(w===myMark?'ã‚ãªãŸã®å‹ã¡!':'ç›¸æ‰‹ã®å‹ã¡');
  myTurn=false;render();
}

// ==== Firebaseã‚·ã‚°ãƒŠãƒªãƒ³ã‚° ====
async function createRoom(roomId){
  isHost=true;
  roomRef=db.ref('rooms/'+roomId);
  roomRef.remove();
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  dc=pc.createDataChannel('chat');
  setupDC();
  pc.onicecandidate=e=>{ if(e.candidate){ roomRef.child('offerCandidates').push(e.candidate.toJSON()); }};
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  await roomRef.set({offer:offer});
  document.getElementById('status').textContent='éƒ¨å±‹ä½œæˆå®Œäº†ã€‚ç›¸æ‰‹ãŒå‚åŠ ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦';

  roomRef.on('value', async snap=>{
    const data=snap.val();
    if(!pc.currentRemoteDescription && data?.answer){
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      document.getElementById('status').textContent='æ¥ç¶šä¸­...';
    }
  });
  roomRef.child('answerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

async function joinRoom(roomId){
  isHost=false;
  roomRef=db.ref('rooms/'+roomId);
  const snap=await roomRef.get();
  if(!snap.exists()){alert('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');return;}
  const offer=snap.val().offer;
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ondatachannel=e=>{dc=e.channel;setupDC();};
  pc.onicecandidate=e=>{ if(e.candidate){ roomRef.child('answerCandidates').push(e.candidate.toJSON()); }};
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
  await roomRef.update({answer:answer});
  document.getElementById('status').textContent='æ¥ç¶šä¸­...';
  roomRef.child('offerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

// ==== DataChannel ====
function setupDC(){
  dc.onopen=()=>{
    document.getElementById('status').textContent='æ¥ç¶šæ¸ˆã¿';
    if(isHost){
      // ãƒ›ã‚¹ãƒˆãŒXã€å…ˆæ‰‹
      myMark='X';
      opMark='O';
      myTurn=true;
      send({type:'assign',mark:'O',yourTurn:false});
    }
    render();
  };
  dc.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==='move'){board[data.i]=opMark;myTurn=true;render();}
    else if(data.type==='assign'){
      // å—ä¿¡å´ã®æ‰‹ç•ªã¨ãƒãƒ¼ã‚¯ã‚’æ­£ã—ãè¨­å®š
      myMark=data.mark;
      opMark=(data.mark==='X'?'O':'X');
      myTurn=data.yourTurn || false;
      render();
    }
    else if(data.type==='chat'){addChat('other',data.text);}
    else if(data.type==='gameover'){showResult(data.winner);}
    else if(data.type==='reset'){resetBoard();}
  };
}

function send(obj){ dc?.send(JSON.stringify(obj)); }

// ==== ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ ====
const chatLog=document.getElementById('chatLog');
function addChat(who,text){
  const div=document.createElement('div');
  div.className='msg '+who;
  div.textContent=text;
  chatLog.appendChild(div);
  chatLog.scrollTop=chatLog.scrollHeight;
}
document.getElementById('sendBtn').onclick=()=>{
  const msg=document.getElementById('chatInput').value.trim();
  if(!msg||!dc?.readyState==='open')return;
  addChat('self',msg);
  send({type:'chat',text:msg});
  document.getElementById('chatInput').value='';
};

// ==== ãƒªã‚»ãƒƒãƒˆ ====
document.getElementById('resetBtn').onclick=()=>{
  resetBoard();
  send({type:'reset'});
};
function resetBoard(){
  board=Array(9).fill(null);
  document.getElementById('result').textContent='';
  myTurn=isHost; // ãƒ›ã‚¹ãƒˆãŒå…ˆæ‰‹ã«æˆ»ã‚‹
  render();
}

// ==== UIãƒœã‚¿ãƒ³ ====
document.getElementById('createBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›');return;}
  createRoom(id);
};
document.getElementById('joinBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('éƒ¨å±‹ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›');return;}
  joinRoom(id);
};
</script>
</body>
</html>
