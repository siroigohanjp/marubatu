<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>オンライン三目並べ（Firebase自動シグナリング）</title>
<style>
  body{font-family:sans-serif;background:#0f1724;color:#fff;text-align:center;padding:20px;}
  #board{display:grid;grid-template-columns:repeat(3,100px);gap:5px;justify-content:center;margin-top:20px;}
  .cell{width:100px;height:100px;background:#1e293b;display:flex;align-items:center;justify-content:center;font-size:48px;cursor:pointer;border-radius:8px;}
  .cell.disabled{opacity:0.6;cursor:not-allowed;}
  input,button{font-size:16px;padding:8px;margin:4px;}
</style>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-database-compat.js"></script>
</head>
<body>
<h1>オンライン三目並べ</h1>

<div>
  <input id="roomId" placeholder="部屋コードを入力" />
  <button id="createBtn">部屋を作る</button>
  <button id="joinBtn">参加する</button>
</div>
<div id="status">状態: 未接続</div>

<div id="board"></div>
<div id="turnInfo"></div>
<div id="result"></div>

<script>
// ==== Firebase設定（★あなたの設定に置き換えてください） ====
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "XXXX",
  appId: "XXXX"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== WebRTC + ゲームロジック ====
let pc, dc;
let myMark = '-', opMark = '-';
let myTurn = false;
let board = Array(9).fill(null);
let roomRef;
let isHost = false;

// 盤面生成
const boardEl = document.getElementById('board');
for(let i=0;i<9;i++){
  const cell=document.createElement('div');
  cell.className='cell';
  cell.dataset.i=i;
  cell.onclick=()=>makeMove(i);
  boardEl.appendChild(cell);
}

function render(){
  board.forEach((v,i)=>{
    const c=boardEl.children[i];
    c.textContent=v||'';
    c.classList.toggle('disabled',!myTurn||v);
  });
  document.getElementById('turnInfo').textContent=myTurn?'あなたの手番':'相手の手番';
}
function winCheck(){
  const lines=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
  for(const [a,b,c] of lines){
    if(board[a]&&board[a]==board[b]&&board[a]==board[c]) return board[a];
  }
  if(board.every(Boolean)) return 'draw';
  return null;
}
function makeMove(i){
  if(!myTurn||board[i])return;
  board[i]=myMark;
  send({type:'move',i});
  myTurn=false;render();
  const w=winCheck();
  if(w){
    send({type:'gameover',winner:w});
    showResult(w);
  }
}
function showResult(w){
  document.getElementById('result').textContent=(w==='draw')?'引き分け':(w===myMark?'あなたの勝ち!':'相手の勝ち');
  myTurn=false;render();
}

// ==== Firebaseシグナリング ====
async function createRoom(roomId){
  isHost=true;
  roomRef=db.ref('rooms/'+roomId);
  roomRef.remove();
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  dc=pc.createDataChannel('chat');
  setupDC();
  pc.onicecandidate=e=>{ if(e.candidate){ roomRef.child('offerCandidates').push(e.candidate.toJSON()); }};
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  await roomRef.set({offer:offer});
  document.getElementById('status').textContent='部屋作成完了。相手が参加するのを待っています…';

  roomRef.on('value', async snap=>{
    const data=snap.val();
    if(!pc.currentRemoteDescription && data?.answer){
      await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      document.getElementById('status').textContent='接続中...';
    }
  });
  roomRef.child('answerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

async function joinRoom(roomId){
  isHost=false;
  roomRef=db.ref('rooms/'+roomId);
  const snap=await roomRef.get();
  if(!snap.exists()){alert('部屋が見つかりません');return;}
  const offer=snap.val().offer;
  pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.ondatachannel=e=>{dc=e.channel;setupDC();};
  pc.onicecandidate=e=>{ if(e.candidate){ roomRef.child('answerCandidates').push(e.candidate.toJSON()); }};
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer=await pc.createAnswer(); await pc.setLocalDescription(answer);
  await roomRef.update({answer:answer});
  document.getElementById('status').textContent='接続中...';
  roomRef.child('offerCandidates').on('child_added',async s=>{
    try{await pc.addIceCandidate(new RTCIceCandidate(s.val()));}catch{}
  });
}

// ==== DataChannel ====
function setupDC(){
  dc.onopen=()=>{
    document.getElementById('status').textContent='接続済み';
    if(isHost){myMark='X';opMark='O';myTurn=true;send({type:'assign',mark:'O'});}
    else{myMark='O';opMark='X';myTurn=false;}
    render();
  };
  dc.onmessage=e=>{
    const data=JSON.parse(e.data);
    if(data.type==='move'){board[data.i]=opMark;myTurn=true;render();}
    else if(data.type==='assign'){opMark=data.mark;myMark=(data.mark==='X'?'O':'X');render();}
    else if(data.type==='gameover'){showResult(data.winner);}
  };
}
function send(obj){ dc.send(JSON.stringify(obj)); }

// ==== UIボタン ====
document.getElementById('createBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('部屋コードを入力');return;}
  createRoom(id);
};
document.getElementById('joinBtn').onclick=()=>{
  const id=document.getElementById('roomId').value.trim();
  if(!id){alert('部屋コードを入力');return;}
  joinRoom(id);
};
</script>
</body>
</html>
